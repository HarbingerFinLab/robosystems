name: Secrets Rotation

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to rotate secrets for"
        required: true
        type: choice
        options:
          - staging
          - prod
      rotate_postgres:
        description: "Rotate PostgreSQL password"
        required: false
        type: boolean
        default: true
      rotate_valkey:
        description: "Rotate Valkey auth token"
        required: false
        type: boolean
        default: true
      rotate_graph_api:
        description: "Rotate Graph API key"
        required: false
        type: boolean
        default: true
      skip_service_refresh:
        description: "Skip service refresh after rotation (for testing)"
        required: false
        type: boolean
        default: false

  # Monthly rotation schedule - staging first, then prod
  # Controlled by SECRETS_ROTATION_ENABLED variable (default: disabled)
  # 6 AM UTC = 12 AM CST / 1 AM CDT (Central Time)
  # Runs 1 hour before graph-maintenance (7 AM UTC) - disable via var if issues
  schedule:
    - cron: "0 6 1 * *"   # Staging: 1st of month at 6 AM UTC (12-1 AM Central)
    - cron: "0 6 2 * *"   # Prod: 2nd of month at 6 AM UTC (12-1 AM Central)

# Minimal top-level permissions - jobs define their own
permissions: {}

env:
  ROTATION_TIMEOUT: 300  # 5 minutes max for each rotation

jobs:
  # ============================================
  # Determine Configuration (schedule gate)
  # ============================================
  config:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      rotate_postgres: ${{ steps.config.outputs.rotate_postgres }}
      rotate_valkey: ${{ steps.config.outputs.rotate_valkey }}
      rotate_graph_api: ${{ steps.config.outputs.rotate_graph_api }}
      skip_service_refresh: ${{ steps.config.outputs.skip_service_refresh }}
      should_run: ${{ steps.config.outputs.should_run }}
    steps:
      - name: Determine Configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use inputs directly
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "rotate_postgres=${{ inputs.rotate_postgres }}" >> $GITHUB_OUTPUT
            echo "rotate_valkey=${{ inputs.rotate_valkey }}" >> $GITHUB_OUTPUT
            echo "rotate_graph_api=${{ inputs.rotate_graph_api }}" >> $GITHUB_OUTPUT
            echo "skip_service_refresh=${{ inputs.skip_service_refresh }}" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Manual trigger for ${{ inputs.environment }}"

          else
            # Scheduled trigger - determine environment from cron
            CRON="${{ github.event.schedule }}"
            if [[ "$CRON" == "0 6 1 "* ]]; then
              ENV="staging"
              ENABLED="${{ vars.SECRETS_ROTATION_ENABLED_STAGING || 'false' }}"
            else
              ENV="prod"
              ENABLED="${{ vars.SECRETS_ROTATION_ENABLED_PROD || 'false' }}"
            fi

            if [ "$ENABLED" != "true" ]; then
              echo "Scheduled rotation is disabled for ${ENV}"
              echo "Set SECRETS_ROTATION_ENABLED_$(echo $ENV | tr '[:lower:]' '[:upper:]')=true to enable"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "environment=${ENV}" >> $GITHUB_OUTPUT
            echo "rotate_postgres=true" >> $GITHUB_OUTPUT
            echo "rotate_valkey=true" >> $GITHUB_OUTPUT
            echo "rotate_graph_api=true" >> $GITHUB_OUTPUT
            echo "skip_service_refresh=false" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Scheduled rotation for ${ENV}"
          fi

  # ============================================
  # PostgreSQL Password Rotation
  # ============================================
  rotate-postgres:
    needs: [config]
    if: needs.config.outputs.should_run == 'true' && needs.config.outputs.rotate_postgres == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read
    outputs:
      status: ${{ steps.rotate.outputs.status }}
      message: ${{ steps.rotate.outputs.message }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Rotate PostgreSQL Password
        id: rotate
        run: |
          ENV="${{ needs.config.outputs.environment }}"
          SECRET_ID="robosystems/${ENV}/postgres/password"

          echo "Initiating PostgreSQL password rotation for ${ENV}..."

          # Check if rotation is already in progress
          SECRET_STATUS=$(aws secretsmanager describe-secret \
            --secret-id "${SECRET_ID}" \
            --query "RotationEnabled" \
            --output text 2>/dev/null || echo "false")

          if [ "$SECRET_STATUS" != "True" ]; then
            echo "Rotation is not enabled for ${SECRET_ID}"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=Rotation not enabled" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Trigger rotation
          echo "Triggering rotation..."
          if aws secretsmanager rotate-secret \
            --secret-id "${SECRET_ID}" \
            --rotation-lambda-arn "$(aws secretsmanager describe-secret \
              --secret-id "${SECRET_ID}" \
              --query "RotationLambdaARN" \
              --output text)"; then

            echo "Waiting for rotation to complete..."

            # Poll for rotation completion (max 5 minutes)
            TIMEOUT=300
            ELAPSED=0
            INTERVAL=15

            while [ $ELAPSED -lt $TIMEOUT ]; do
              # Check if there's a pending version
              if ! VERSIONS=$(aws secretsmanager describe-secret \
                --secret-id "${SECRET_ID}" \
                --query "VersionIdsToStages" \
                --output json 2>&1); then
                echo "Error checking rotation status: $VERSIONS" >&2
                echo "status=failed" >> $GITHUB_OUTPUT
                echo "message=Failed to check rotation status" >> $GITHUB_OUTPUT
                exit 1
              fi

              # If no AWSPENDING version exists, rotation is complete
              if ! echo "$VERSIONS" | grep -q "AWSPENDING"; then
                echo "PostgreSQL password rotation completed successfully"
                echo "status=success" >> $GITHUB_OUTPUT
                echo "message=Password rotated successfully" >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "  Rotation in progress... (${ELAPSED}s elapsed)"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            echo "Rotation timed out after ${TIMEOUT}s - may still be in progress"
            echo "status=timeout" >> $GITHUB_OUTPUT
            echo "message=Rotation timed out after ${TIMEOUT}s" >> $GITHUB_OUTPUT
          else
            echo "Failed to trigger rotation"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=Failed to trigger rotation" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================
  # Valkey Auth Token Rotation
  # ============================================
  rotate-valkey:
    needs: [config]
    if: needs.config.outputs.should_run == 'true' && needs.config.outputs.rotate_valkey == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      id-token: write
      contents: read
    outputs:
      status: ${{ steps.rotate.outputs.status }}
      message: ${{ steps.rotate.outputs.message }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Rotate Valkey Auth Token
        id: rotate
        run: |
          ENV="${{ needs.config.outputs.environment }}"
          SECRET_ID="robosystems/${ENV}/valkey/auth"

          echo "Initiating Valkey auth token rotation for ${ENV}..."

          # Check if secret exists and rotation is enabled
          SECRET_INFO=$(aws secretsmanager describe-secret \
            --secret-id "${SECRET_ID}" 2>/dev/null || echo "NOT_FOUND")

          if [ "$SECRET_INFO" == "NOT_FOUND" ]; then
            echo "Secret ${SECRET_ID} not found - Valkey may not use auth"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=Secret not found" >> $GITHUB_OUTPUT
            exit 0
          fi

          ROTATION_ENABLED=$(echo "$SECRET_INFO" | jq -r '.RotationEnabled // false')

          if [ "$ROTATION_ENABLED" != "true" ]; then
            echo "Rotation is not enabled for ${SECRET_ID}"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=Rotation not enabled" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Trigger rotation
          echo "Triggering rotation..."
          LAMBDA_ARN=$(echo "$SECRET_INFO" | jq -r '.RotationLambdaARN')

          if aws secretsmanager rotate-secret \
            --secret-id "${SECRET_ID}" \
            --rotation-lambda-arn "${LAMBDA_ARN}"; then

            echo "Waiting for rotation to complete..."
            echo "  (Valkey rotation includes ElastiCache update - may take several minutes)"

            # Poll for rotation completion (max 12 minutes for Valkey)
            TIMEOUT=720
            ELAPSED=0
            INTERVAL=30

            while [ $ELAPSED -lt $TIMEOUT ]; do
              if ! VERSIONS=$(aws secretsmanager describe-secret \
                --secret-id "${SECRET_ID}" \
                --query "VersionIdsToStages" \
                --output json 2>&1); then
                echo "Error checking rotation status: $VERSIONS" >&2
                echo "status=failed" >> $GITHUB_OUTPUT
                echo "message=Failed to check rotation status" >> $GITHUB_OUTPUT
                exit 1
              fi

              if ! echo "$VERSIONS" | grep -q "AWSPENDING"; then
                echo "Valkey auth token rotation completed successfully"
                echo "status=success" >> $GITHUB_OUTPUT
                echo "message=Auth token rotated successfully" >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "  Rotation in progress... (${ELAPSED}s elapsed)"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            echo "Rotation timed out after ${TIMEOUT}s"
            echo "status=timeout" >> $GITHUB_OUTPUT
            echo "message=Rotation timed out after ${TIMEOUT}s" >> $GITHUB_OUTPUT
          else
            echo "Failed to trigger rotation"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=Failed to trigger rotation" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================
  # Graph API Key Rotation
  # ============================================
  rotate-graph-api:
    needs: [config]
    if: needs.config.outputs.should_run == 'true' && needs.config.outputs.rotate_graph_api == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read
    outputs:
      status: ${{ steps.rotate.outputs.status }}
      message: ${{ steps.rotate.outputs.message }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Rotate Graph API Key
        id: rotate
        run: |
          ENV="${{ needs.config.outputs.environment }}"
          SECRET_ID="robosystems/${ENV}/graph-api"

          echo "Initiating Graph API key rotation for ${ENV}..."

          # Check if secret exists and rotation is enabled
          SECRET_INFO=$(aws secretsmanager describe-secret \
            --secret-id "${SECRET_ID}" 2>/dev/null || echo "NOT_FOUND")

          if [ "$SECRET_INFO" == "NOT_FOUND" ]; then
            echo "Secret ${SECRET_ID} not found"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=Secret not found" >> $GITHUB_OUTPUT
            exit 0
          fi

          ROTATION_ENABLED=$(echo "$SECRET_INFO" | jq -r '.RotationEnabled // false')

          if [ "$ROTATION_ENABLED" != "true" ]; then
            echo "Rotation is not enabled for ${SECRET_ID}"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "message=Rotation not enabled" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Trigger rotation
          echo "Triggering rotation..."
          LAMBDA_ARN=$(echo "$SECRET_INFO" | jq -r '.RotationLambdaARN')

          if aws secretsmanager rotate-secret \
            --secret-id "${SECRET_ID}" \
            --rotation-lambda-arn "${LAMBDA_ARN}"; then

            echo "Waiting for rotation to complete..."

            # Poll for rotation completion (max 5 minutes)
            TIMEOUT=300
            ELAPSED=0
            INTERVAL=15

            while [ $ELAPSED -lt $TIMEOUT ]; do
              if ! VERSIONS=$(aws secretsmanager describe-secret \
                --secret-id "${SECRET_ID}" \
                --query "VersionIdsToStages" \
                --output json 2>&1); then
                echo "Error checking rotation status: $VERSIONS" >&2
                echo "status=failed" >> $GITHUB_OUTPUT
                echo "message=Failed to check rotation status" >> $GITHUB_OUTPUT
                exit 1
              fi

              if ! echo "$VERSIONS" | grep -q "AWSPENDING"; then
                echo "Graph API key rotation completed successfully"
                echo "status=success" >> $GITHUB_OUTPUT
                echo "message=API key rotated successfully" >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "  Rotation in progress... (${ELAPSED}s elapsed)"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            echo "Rotation timed out after ${TIMEOUT}s"
            echo "status=timeout" >> $GITHUB_OUTPUT
            echo "message=Rotation timed out after ${TIMEOUT}s" >> $GITHUB_OUTPUT
          else
            echo "Failed to trigger rotation"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=Failed to trigger rotation" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================
  # Service Refresh (after all rotations complete)
  # ============================================
  service-refresh:
    needs: [config, rotate-postgres, rotate-valkey, rotate-graph-api]
    if: |
      always() &&
      needs.config.outputs.should_run == 'true' &&
      needs.config.outputs.skip_service_refresh != 'true' &&
      (needs.rotate-postgres.outputs.status == 'success' ||
       needs.rotate-valkey.outputs.status == 'success' ||
       needs.rotate-graph-api.outputs.status == 'success')
    uses: ./.github/workflows/service-refresh.yml
    with:
      environment: ${{ needs.config.outputs.environment }}
      graph_refresh_enabled: "true"
      api_refresh_enabled: "true"
      dagster_refresh_enabled: "true"
      graph_node_types: "all"
    secrets:
      ACTIONS_TOKEN: ${{ secrets.ACTIONS_TOKEN }}

  # ============================================
  # Send Email Notification
  # ============================================
  notify:
    needs: [config, rotate-postgres, rotate-valkey, rotate-graph-api, service-refresh]
    if: always() && needs.config.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Send SNS Notification
        run: |
          ENV="${{ needs.config.outputs.environment }}"
          REGION="${{ vars.AWS_REGION || 'us-east-1' }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          # Determine overall status
          PG_STATUS="${{ needs.rotate-postgres.outputs.status }}"
          VK_STATUS="${{ needs.rotate-valkey.outputs.status }}"
          GA_STATUS="${{ needs.rotate-graph-api.outputs.status }}"
          REFRESH_STATUS="${{ needs.service-refresh.result }}"

          # Check for any failures
          HAS_FAILURE=false
          if [ "$PG_STATUS" == "failed" ] || [ "$VK_STATUS" == "failed" ] || [ "$GA_STATUS" == "failed" ]; then
            HAS_FAILURE=true
          fi

          # Check for any successes
          HAS_SUCCESS=false
          if [ "$PG_STATUS" == "success" ] || [ "$VK_STATUS" == "success" ] || [ "$GA_STATUS" == "success" ]; then
            HAS_SUCCESS=true
          fi

          # Determine subject
          if [ "$HAS_FAILURE" == "true" ]; then
            SUBJECT="[ALERT] Secrets Rotation Failed - ${ENV}"
          elif [ "$HAS_SUCCESS" == "true" ]; then
            SUBJECT="Secrets Rotation Completed - ${ENV}"
          else
            SUBJECT="Secrets Rotation Skipped - ${ENV}"
          fi

          # Build message body
          MESSAGE="RoboSystems Secrets Rotation Report
          =====================================

          Environment: ${ENV}
          Trigger: ${{ github.event_name }}
          Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Rotation Results:
          -----------------
          PostgreSQL Password: ${PG_STATUS:-not_requested} - ${{ needs.rotate-postgres.outputs.message }}
          Valkey Auth Token:   ${VK_STATUS:-not_requested} - ${{ needs.rotate-valkey.outputs.message }}
          Graph API Key:       ${GA_STATUS:-not_requested} - ${{ needs.rotate-graph-api.outputs.message }}

          Service Refresh: ${REFRESH_STATUS}

          ---
          This notification was sent by GitHub Actions.
          Secrets rotation is now managed via GitHub Actions workflow instead of AWS Secrets Manager schedules.
          "

          # Use existing postgres alert topic (created by CloudFormation with AWS_SNS_ALERT_EMAIL subscriber)
          SNS_TOPIC="arn:aws:sns:${REGION}:${ACCOUNT_ID}:robosystems-postgres-${ENV}-alerts"

          if aws sns publish \
            --topic-arn "${SNS_TOPIC}" \
            --subject "${SUBJECT}" \
            --message "${MESSAGE}"; then
            echo "SNS notification sent to ${SNS_TOPIC}"
          else
            echo "Warning: Could not send SNS notification"
            echo "Topic ${SNS_TOPIC} may not exist - deploy postgres stack first"
          fi

  # ============================================
  # Summary
  # ============================================
  summary:
    needs: [config, rotate-postgres, rotate-valkey, rotate-graph-api, service-refresh, notify]
    if: always() && needs.config.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "### Secrets Rotation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.config.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Secret | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # PostgreSQL
          PG_STATUS="${{ needs.rotate-postgres.outputs.status }}"
          PG_MSG="${{ needs.rotate-postgres.outputs.message }}"
          case "$PG_STATUS" in
            "success") echo "| PostgreSQL Password | Rotated | ${PG_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "skipped") echo "| PostgreSQL Password | Skipped | ${PG_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "timeout") echo "| PostgreSQL Password | Timeout | ${PG_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "failed")  echo "| PostgreSQL Password | **Failed** | ${PG_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            *)         echo "| PostgreSQL Password | Not requested | - |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          # Valkey
          VK_STATUS="${{ needs.rotate-valkey.outputs.status }}"
          VK_MSG="${{ needs.rotate-valkey.outputs.message }}"
          case "$VK_STATUS" in
            "success") echo "| Valkey Auth Token | Rotated | ${VK_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "skipped") echo "| Valkey Auth Token | Skipped | ${VK_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "timeout") echo "| Valkey Auth Token | Timeout | ${VK_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "failed")  echo "| Valkey Auth Token | **Failed** | ${VK_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            *)         echo "| Valkey Auth Token | Not requested | - |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          # Graph API
          GA_STATUS="${{ needs.rotate-graph-api.outputs.status }}"
          GA_MSG="${{ needs.rotate-graph-api.outputs.message }}"
          case "$GA_STATUS" in
            "success") echo "| Graph API Key | Rotated | ${GA_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "skipped") echo "| Graph API Key | Skipped | ${GA_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "timeout") echo "| Graph API Key | Timeout | ${GA_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            "failed")  echo "| Graph API Key | **Failed** | ${GA_MSG} |" >> $GITHUB_STEP_SUMMARY ;;
            *)         echo "| Graph API Key | Not requested | - |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY

          # Service Refresh
          REFRESH_RESULT="${{ needs.service-refresh.result }}"
          if [ "${{ needs.config.outputs.skip_service_refresh }}" == "true" ]; then
            echo "**Service Refresh:** Skipped (by request)" >> $GITHUB_STEP_SUMMARY
          elif [ "$REFRESH_RESULT" == "success" ]; then
            echo "**Service Refresh:** Completed" >> $GITHUB_STEP_SUMMARY
          elif [ "$REFRESH_RESULT" == "skipped" ]; then
            echo "**Service Refresh:** Skipped (no rotations succeeded)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Service Refresh:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Notification
          NOTIFY_RESULT="${{ needs.notify.result }}"
          echo "**Email Notification:** ${NOTIFY_RESULT}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Secrets rotation is managed via GitHub Actions. AWS Secrets Manager schedules have been disabled.*" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Enable staging: Set \`SECRETS_ROTATION_ENABLED_STAGING=true\`" >> $GITHUB_STEP_SUMMARY
          echo "- Enable prod: Set \`SECRETS_ROTATION_ENABLED_PROD=true\`" >> $GITHUB_STEP_SUMMARY
          echo "- Schedule: 1st of month (staging), 2nd of month (prod) at 6 AM UTC (12-1 AM Central)" >> $GITHUB_STEP_SUMMARY
