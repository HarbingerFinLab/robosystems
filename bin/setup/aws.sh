#!/bin/bash
# =============================================================================
# ROBOSYSTEMS SERVICE AWS SECRETS MANAGER SETUP SCRIPT
# =============================================================================
#
# This script sets up the unified RoboSystems secrets in AWS Secrets Manager.
# These secrets are shared across all RoboSystems applications (backend service,
# RoboLedger frontend, RoboInvestor frontend). All database and infrastructure
# secrets are automatically generated by CloudFormation templates.
#
# Usage:
#   just setup-aws
#   or directly: bin/setup/aws
#
# Base secrets created:
# - robosystems/prod (shared across all production apps)
# - robosystems/staging (shared across all staging apps)
#
# =============================================================================

set -e

echo "=== RoboSystems AWS Secrets Manager Setup ==="
echo ""

# =============================================================================
# SECRET CONFIGURATION REFERENCE
# =============================================================================
#
# This script creates AWS Secrets Manager secrets with the following structure:
#
# PRODUCTION (robosystems/prod):
# - ENVIRONMENT: prod
# - BILLING_ENABLED: Set to "false" for forked/self-hosted deployments
# - AI service keys (managed via GitHub Secrets, not AWS Secrets Manager)
# - INTUIT_*, PLAID_*: External service integrations (production)
# - NEXTAUTH_*: Authentication configuration
# - ROBOSYSTEMS_*: Internal API configuration
# - Feature flags and worker configuration
#
# STAGING (robosystems/staging):
# - Same structure as production but with staging/sandbox endpoints
# - ENVIRONMENT: staging
# - External services point to sandbox environments
#
# =============================================================================

# =============================================================================
# AWS SECRETS MANAGER SETUP FUNCTIONS
# =============================================================================

function generate_secret_key() {
    # Generate a secure random key using openssl
    openssl rand -base64 32
}

function create_production_secret() {
    echo "Checking production secret..."

    # Check if secret already exists - don't overwrite!
    if aws secretsmanager describe-secret --secret-id "robosystems/prod" >/dev/null 2>&1; then
        echo "‚úÖ Production secret already exists - skipping (won't overwrite)"
        return 0
    fi

    echo "Creating production secret..."

    # Create Production Secret
    aws secretsmanager create-secret \
        --name "robosystems/prod" \
        --description "RoboSystems production environment secrets" \
        --tags Key=Environment,Value=prod Key=Service,Value=RoboSystems Key=Component,Value=Secrets

    echo "Generating secure keys..."
    PROD_JWT_SECRET=$(generate_secret_key)
    PROD_CONNECTION_KEY=$(generate_secret_key)
    PROD_BACKUP_KEY=$(generate_secret_key)

    echo "Setting production secret values..."

    # Build S3_NAMESPACE entry if provided (for forks)
    local s3_namespace_entry=""
    if [ -n "${S3_NAMESPACE:-}" ]; then
        s3_namespace_entry="\"S3_NAMESPACE\": \"${S3_NAMESPACE}\","
        echo "Including S3_NAMESPACE: ${S3_NAMESPACE}"
    fi

    # Set Production Secret Values
    aws secretsmanager put-secret-value \
        --secret-id "robosystems/prod" \
        --secret-string '{
        '"${s3_namespace_entry}"'
        "BILLING_ENABLED": "false",
        "CONNECTION_CREDENTIALS_KEY": "'"$PROD_CONNECTION_KEY"'",
        "CONNECTION_PLAID_ENABLED": "false",
        "CONNECTION_QUICKBOOKS_ENABLED": "false",
        "CONNECTION_SEC_ENABLED": "false",
        "INTUIT_CLIENT_ID": "Intuit.ipp.application.your_client_id",
        "INTUIT_CLIENT_SECRET": "your_quickbooks_client_secret_here",
        "INTUIT_ENVIRONMENT": "production",
        "INTUIT_REDIRECT_URI": "https://api.robosystems.ai/auth/callback",
        "JWT_SECRET_KEY": "'"$PROD_JWT_SECRET"'",
        "GRAPH_BACKUP_ENCRYPTION_KEY": "'"$PROD_BACKUP_KEY"'",
        "LOAD_SHEDDING_ENABLED": "true",
        "ORG_GRAPHS_DEFAULT_LIMIT": "5",
        "OPENFIGI_API_KEY": "your_openfigi_api_key_here",
        "OTEL_ENABLED": "false",
        "PLAID_CLIENT_ID": "your_plaid_client_id_here",
        "PLAID_CLIENT_SECRET": "your_plaid_client_secret_here",
        "PLAID_ENVIRONMENT": "production",
        "RATE_LIMIT_ENABLED": "true",
        "CAPTCHA_ENABLED": "true",
        "EMAIL_VERIFICATION_ENABLED": "true",
        "SEC_GOV_USER_AGENT": "RoboSystems/1.0 (contact@robosystems.ai)",
        "SECURITY_AUDIT_ENABLED": "true",
        "SSE_ENABLED": "true",
        "TURNSTILE_SECRET_KEY": "your_cloudflare_turnstile_secret_key",
        "TURNSTILE_SITE_KEY": "your_cloudflare_turnstile_site_key",
        "USER_REGISTRATION_ENABLED": "true",
        "AGENT_POST_ENABLED": "true",
        "BACKUP_CREATION_ENABLED": "true",
        "CSP_TRUSTED_TYPES_ENABLED": "false",
        "DIRECT_GRAPH_PROVISIONING_ENABLED": "true",
        "ORG_MEMBER_INVITATIONS_ENABLED": "false",
        "SHARED_MASTER_READS_ENABLED": "true",
        "SUBGRAPH_CREATION_ENABLED": "true",
        "BILLING_SCHEDULES_ENABLED": "true",
        "INSTANCE_SCHEDULES_ENABLED": "true",
        "SEC_DOWNLOAD_SCHEDULE_ENABLED": "false",
        "SEC_MATERIALIZE_SCHEDULE_ENABLED": "false",
        "SEC_PARALLEL_SENSOR_ENABLED": "false",
        "SHARED_REPO_SCHEDULE_ENABLED": "false"
    }'

    echo "Production secret created successfully!"
}

function create_staging_secret() {
    echo "Checking staging secret..."

    # Check if secret already exists - don't overwrite!
    if aws secretsmanager describe-secret --secret-id "robosystems/staging" >/dev/null 2>&1; then
        echo "‚úÖ Staging secret already exists - skipping (won't overwrite)"
        return 0
    fi

    echo "Creating staging secret..."

    # Create Staging Secret
    aws secretsmanager create-secret \
        --name "robosystems/staging" \
        --description "RoboSystems staging environment secrets" \
        --tags Key=Environment,Value=staging Key=Service,Value=RoboSystems Key=Component,Value=Secrets

    echo "Generating secure keys..."
    STAGING_JWT_SECRET=$(generate_secret_key)
    STAGING_CONNECTION_KEY=$(generate_secret_key)
    STAGING_BACKUP_KEY=$(generate_secret_key)

    echo "Setting staging secret values..."

    # Build S3_NAMESPACE entry if provided (for forks)
    local s3_namespace_entry=""
    if [ -n "${S3_NAMESPACE:-}" ]; then
        s3_namespace_entry="\"S3_NAMESPACE\": \"${S3_NAMESPACE}\","
        echo "Including S3_NAMESPACE: ${S3_NAMESPACE}"
    fi

    # Set Staging Secret Values
    aws secretsmanager put-secret-value \
        --secret-id "robosystems/staging" \
        --secret-string '{
        '"${s3_namespace_entry}"'
        "BILLING_ENABLED": "false",
        "CONNECTION_CREDENTIALS_KEY": "'"$STAGING_CONNECTION_KEY"'",
        "CONNECTION_PLAID_ENABLED": "false",
        "CONNECTION_QUICKBOOKS_ENABLED": "false",
        "CONNECTION_SEC_ENABLED": "false",
        "INTUIT_CLIENT_ID": "Intuit.ipp.application.your_sandbox_client_id",
        "INTUIT_CLIENT_SECRET": "your_quickbooks_sandbox_client_secret_here",
        "INTUIT_ENVIRONMENT": "sandbox",
        "INTUIT_REDIRECT_URI": "https://staging.api.robosystems.ai/auth/callback",
        "JWT_SECRET_KEY": "'"$STAGING_JWT_SECRET"'",
        "GRAPH_BACKUP_ENCRYPTION_KEY": "'"$STAGING_BACKUP_KEY"'",
        "LOAD_SHEDDING_ENABLED": "true",
        "ORG_GRAPHS_DEFAULT_LIMIT": "5",
        "OPENFIGI_API_KEY": "your_openfigi_api_key_here",
        "OTEL_ENABLED": "false",
        "PLAID_CLIENT_ID": "your_plaid_sandbox_client_id_here",
        "PLAID_CLIENT_SECRET": "your_plaid_sandbox_client_secret_here",
        "PLAID_ENVIRONMENT": "sandbox",
        "RATE_LIMIT_ENABLED": "true",
        "CAPTCHA_ENABLED": "false",
        "EMAIL_VERIFICATION_ENABLED": "false",
        "SEC_GOV_USER_AGENT": "RoboSystems-Staging/1.0 (contact@robosystems.ai)",
        "SECURITY_AUDIT_ENABLED": "true",
        "SSE_ENABLED": "true",
        "TURNSTILE_SECRET_KEY": "your_cloudflare_turnstile_secret_key",
        "TURNSTILE_SITE_KEY": "your_cloudflare_turnstile_site_key",
        "USER_REGISTRATION_ENABLED": "true",
        "AGENT_POST_ENABLED": "true",
        "BACKUP_CREATION_ENABLED": "true",
        "CSP_TRUSTED_TYPES_ENABLED": "false",
        "DIRECT_GRAPH_PROVISIONING_ENABLED": "true",
        "ORG_MEMBER_INVITATIONS_ENABLED": "false",
        "SHARED_MASTER_READS_ENABLED": "true",
        "SUBGRAPH_CREATION_ENABLED": "true",
        "BILLING_SCHEDULES_ENABLED": "true",
        "INSTANCE_SCHEDULES_ENABLED": "true",
        "SEC_DOWNLOAD_SCHEDULE_ENABLED": "false",
        "SEC_MATERIALIZE_SCHEDULE_ENABLED": "false",
        "SEC_PARALLEL_SENSOR_ENABLED": "false",
        "SHARED_REPO_SCHEDULE_ENABLED": "false"
    }'

    echo "Staging secret created successfully!"
}

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

function check_prerequisites() {
    echo "Checking prerequisites..."

    # Check AWS CLI
    if ! command -v aws >/dev/null 2>&1; then
        echo "‚ùå AWS CLI is not installed. Please install it first."
        echo "   Visit: https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html"
        exit 1
    fi

    # Check AWS credentials
    if ! aws sts get-caller-identity >/dev/null 2>&1; then
        echo "‚ùå AWS credentials not configured or invalid."
        echo "   Run: aws configure"
        exit 1
    fi

    echo "‚úÖ Prerequisites check passed"
    echo ""
}

# =============================================================================
# MAIN SCRIPT EXECUTION
# =============================================================================

function main() {
    check_prerequisites

    echo "This script creates RoboSystems secrets in AWS Secrets Manager."
    echo ""
    echo "Safe to run multiple times - existing secrets are NOT overwritten."
    echo "Keys (JWT, encryption) are auto-generated on first run."
    echo ""

    # Show current AWS identity
    local aws_identity=$(aws sts get-caller-identity --query 'Account' --output text 2>/dev/null)
    echo "AWS Account: $aws_identity"
    echo ""

    # Check what already exists
    local prod_exists=false
    local staging_exists=false
    if aws secretsmanager describe-secret --secret-id "robosystems/prod" >/dev/null 2>&1; then
        prod_exists=true
    fi
    if aws secretsmanager describe-secret --secret-id "robosystems/staging" >/dev/null 2>&1; then
        staging_exists=true
    fi

    if $prod_exists && $staging_exists; then
        echo "‚úÖ Both secrets already exist - nothing to do"
        echo ""
        echo "To update individual values, use AWS Console or CLI:"
        echo "   aws secretsmanager get-secret-value --secret-id robosystems/prod"
        echo "   aws secretsmanager put-secret-value --secret-id robosystems/prod --secret-string '...'"
        return 0
    fi

    if $prod_exists; then
        echo "‚ÑπÔ∏è  Production secret exists (will skip)"
    else
        echo "‚ö° Production secret will be created"
    fi
    if $staging_exists; then
        echo "‚ÑπÔ∏è  Staging secret exists (will skip)"
    else
        echo "‚ö° Staging secret will be created"
    fi
    echo ""

    read -p "Continue? (Y/n): " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    echo ""
    echo "Creating secrets..."
    echo ""

    create_production_secret
    echo ""
    create_staging_secret
    echo ""

    echo "‚úÖ AWS Secrets Manager setup completed!"
    echo ""
    echo "üìã To customize integration credentials later:"
    echo "   aws secretsmanager get-secret-value --secret-id robosystems/prod --query SecretString --output text | jq ."
    echo ""
    echo "   Then update with:"
    echo "   aws secretsmanager put-secret-value --secret-id robosystems/prod --secret-string '\$(cat updated-secrets.json)'"
}

# Run main function if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
